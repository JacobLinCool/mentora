rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- Helpers ---------- */
    function isSignedIn() {
      return request.auth != null;
    }



    // Membership checks (active users should have roster doc id == uid)
    function isCourseMember(courseId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/courses/$(courseId)/roster/$(request.auth.uid));
    }

    function membershipDoc(courseId) {
      return get(/databases/$(database)/documents/courses/$(courseId)/roster/$(request.auth.uid));
    }

    function hasRole(courseId, role) {
      return isCourseMember(courseId) &&
             membershipDoc(courseId).data.role == role;
    }

    function isTA(courseId) {
      return hasRole(courseId, "ta");
    }



    function isInstructorOfCourse(courseId) {
      // hasRole already checks isCourseMember internally
      return hasRole(courseId, "instructor");
    }

    function isOwnerOfCourse(courseId) {
      // Check if course exists first, then check ownership
      return isSignedIn() && 
        exists(/databases/$(database)/documents/courses/$(courseId)) &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.ownerId == request.auth.uid;
    }



    function isPublicCourse(courseId) {
      return exists(/databases/$(database)/documents/courses/$(courseId)) &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.visibility == "public";
    }

    function canEditCourseResource(courseId) {
      // Check owner first (simplest check), then fall back to role-based checks
      return isSignedIn() && (
        isOwnerOfCourse(courseId) || isInstructorOfCourse(courseId) || isTA(courseId)
      );
    }

    function targetNotExists() {
      // It's required for querying non-existent docs, e.g. an empty collection
      return resource == null || resource.data == null;
    }



    function isValidUserProfile(data) {
      return data.uid is string && data.uid.size() <= 128 &&
             data.displayName is string && data.displayName.size() >= 1 && data.displayName.size() <= 100 &&
             data.email is string && data.email.size() <= 320 &&
             (data.photoURL == null || (data.photoURL is string && data.photoURL.size() <= 2048)) &&
             data.createdAt is number && data.updatedAt is number;
    }

    function isValidCourseDoc(data) {
      return data.title is string && data.title.size() >= 1 && data.title.size() <= 200 &&
             data.code is string && data.code.size() >= 6 && data.code.size() <= 64 &&
             data.ownerId is string && data.ownerId.size() <= 128 &&
             (!('visibility' in data) || data.visibility in ["public", "unlisted", "private"]) &&
             (!('passwordHash' in data) || data.passwordHash == null || (data.passwordHash is string && data.passwordHash.size() <= 512)) &&
             (!('theme' in data) || data.theme == null || (data.theme is string && data.theme.size() <= 200)) &&
             (!('description' in data) || data.description == null || (data.description is string && data.description.size() <= 5000)) &&
             (!('thumbnail' in data) || data.thumbnail == null ||
               (data.thumbnail is map &&
                'storagePath' in data.thumbnail && data.thumbnail.storagePath is string && data.thumbnail.storagePath.size() <= 1024 &&
                (!('url' in data.thumbnail) || data.thumbnail.url == null || (data.thumbnail.url is string && data.thumbnail.url.size() <= 2048))
               )
             ) &&
             (!('isDemo' in data) || data.isDemo is bool) &&
             (!('demoPolicy' in data) || data.demoPolicy == null ||
               (data.demoPolicy is map &&
                'maxFreeCreditsPerUser' in data.demoPolicy && data.demoPolicy.maxFreeCreditsPerUser is number && data.demoPolicy.maxFreeCreditsPerUser >= 0 &&
                (!('maxTurnsPerConversation' in data.demoPolicy) || data.demoPolicy.maxTurnsPerConversation == null || (data.demoPolicy.maxTurnsPerConversation is number && data.demoPolicy.maxTurnsPerConversation > 0))
               )
             ) &&
             data.createdAt is number && data.updatedAt is number;
    }

    function isValidRosterEntry(data) {
      return (data.userId == null || (data.userId is string && data.userId.size() <= 128)) &&
             data.email is string && data.email.size() <= 320 &&
             data.role in ["student", "auditor", "ta", "instructor"] &&
             data.status in ["invited", "active", "removed"] &&
             (data.joinedAt == null || data.joinedAt is number);
    }

    function isValidAssignment(data) {
      return data.id is string && data.id.size() >= 6 && data.id.size() <= 128 &&
             (data.courseId == null || (data.courseId is string && data.courseId.size() <= 128)) &&
             (!('topicId' in data) || data.topicId == null || (data.topicId is string && data.topicId.size() <= 128)) &&
             (!('orderInTopic' in data) || data.orderInTopic == null || (data.orderInTopic is number)) &&
             data.title is string && data.title.size() >= 1 && data.title.size() <= 300 &&
             data.prompt is string && data.prompt.size() >= 1 && data.prompt.size() <= 50000 &&
             data.mode == "instant" &&
             data.startAt is number &&
             (data.dueAt == null || data.dueAt is number) &&
             data.allowLate is bool &&
             data.allowResubmit is bool &&
             data.createdBy is string && data.createdBy.size() <= 128 &&
             data.createdAt is number && data.updatedAt is number;
    }

    function isValidTopic(data) {
      return data.id is string && data.id.size() >= 6 && data.id.size() <= 128 &&
             data.courseId is string && data.courseId.size() <= 128 &&
             data.title is string && data.title.size() >= 1 && data.title.size() <= 200 &&
             (!('description' in data) || data.description == null || (data.description is string && data.description.size() <= 2000)) &&
             (!('order' in data) || data.order == null || (data.order is number)) &&
             data.createdBy is string && data.createdBy.size() <= 128 &&
             data.createdAt is number && data.updatedAt is number;
    }



    function isValidSubmission(data) {
      return data.userId is string && data.userId.size() <= 128 &&
             data.state in ["in_progress", "submitted", "graded_complete"] &&
             data.startedAt is number &&
             (data.submittedAt == null || data.submittedAt is number) &&
             data.late is bool &&
             (data.scoreCompletion == null || data.scoreCompletion is number) &&
             (data.notes == null || (data.notes is string && data.notes.size() <= 10000));
    }

    function isValidConversation(data) {
      return data.assignmentId is string && data.assignmentId.size() <= 128 &&
             data.userId is string && data.userId.size() <= 128 &&
             data.state in ["awaiting_idea", "adding_counterpoint", "awaiting_followup", "adding_final_summary", "closed"] &&
             data.lastActionAt is number &&
             data.createdAt is number && data.updatedAt is number &&
             data.turns is list && data.turns.size() <= 1000;
    }

    /* ---------- Users ---------- */
    match /users/{uid} {
      allow get: if isSignedIn() && (uid == request.auth.uid);
      allow list: if false; // users cannot list all users
      allow create: if isSignedIn() && (uid == request.auth.uid) &&
                       isValidUserProfile(request.resource.data);
      allow update: if isSignedIn() && (uid == request.auth.uid) &&
                       isValidUserProfile(request.resource.data);
      allow delete: if false; // keep profiles
    }

    /* ---------- Courses ---------- */
    match /courses/{courseId} {
      // Public courses are readable by anyone; private/unlisted require membership or ownership
      allow get: if targetNotExists() ||
        (resource.data != null && 'visibility' in resource.data && resource.data.visibility == "public") ||
        (isSignedIn() && resource.data != null && (isCourseMember(courseId) || ('ownerId' in resource.data && resource.data.ownerId == request.auth.uid)));

      // List: same rules as get
      allow list: if targetNotExists() ||
        (resource.data != null && 'visibility' in resource.data && resource.data.visibility == "public") ||
        (isSignedIn() && resource.data != null && (isCourseMember(courseId) || ('ownerId' in resource.data && resource.data.ownerId == request.auth.uid)));

      allow create: if isSignedIn() && isValidCourseDoc(request.resource.data);
      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid || isInstructorOfCourse(courseId)
      ) && isValidCourseDoc(request.resource.data);
      allow delete: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid || isInstructorOfCourse(courseId)
      );
    }

    /* ---------- Topics ---------- */
    match /topics/{topicId} {
      allow get: if targetNotExists() ||
        (resource != null && resource.data != null && resource.data.courseId is string && isPublicCourse(resource.data.courseId)) ||
        (isSignedIn() && resource != null && resource.data != null && (isCourseMember(resource.data.courseId) || canEditCourseResource(resource.data.courseId)));

      allow list: if targetNotExists() ||
        (resource != null && resource.data != null && resource.data.courseId is string && isPublicCourse(resource.data.courseId)) ||
        (isSignedIn() && resource != null && resource.data != null && (isCourseMember(resource.data.courseId) || canEditCourseResource(resource.data.courseId)));

      allow create: if isSignedIn() &&
        canEditCourseResource(request.resource.data.courseId) &&
        isValidTopic(request.resource.data);

      allow update: if isSignedIn() &&
        resource.data.courseId == request.resource.data.courseId &&
        canEditCourseResource(resource.data.courseId) &&
        isValidTopic(request.resource.data);

      allow delete: if isSignedIn() &&
        canEditCourseResource(resource.data.courseId);
    }

    /* ---------- Wallets / Ledger (read-only to clients) ---------- */
    match /wallets/{walletId} {
      allow get: if isSignedIn() && (
        (resource.data.ownerId == request.auth.uid) &&
        (resource.data.ownerType in ["user", "host"])
      );
      allow list: if false;

      // Wallet creation/updates are server-side only.
      allow create, update, delete: if false;

      match /entries/{entryId} {
        allow get, list: if isSignedIn() && (
          get(/databases/$(database)/documents/wallets/$(walletId)).data.ownerId == request.auth.uid
        );
        // Ledger writes are server-side only.
        allow create, update, delete: if false;
      }
    }

    /* ---------- Course Roster ---------- */
    match /courses/{courseId}/roster/{memberId} {
      // Members can read their own roster entry
      allow get: if isSignedIn() && (
        memberId == request.auth.uid ||
        isCourseMember(courseId)
      );

      // Members can list the entire roster if they are a member
      allow list: if isSignedIn() && isCourseMember(courseId);

      // Only instructor (or owner) can invite / change roles / remove
      allow create, update: if isSignedIn() && (
        // allow if the course doc is not exists (initial setup)
        !exists(/databases/$(database)/documents/courses/$(courseId)) ||
        isInstructorOfCourse(courseId) ||
        isOwnerOfCourse(courseId)
      ) && isValidRosterEntry(request.resource.data);
      allow delete: if isSignedIn() && (
        isInstructorOfCourse(courseId) ||
        isOwnerOfCourse(courseId)
      );
    }

    /* ---------- Assignments (top-level) ---------- */
    match /assignments/{aid} {
      allow get: if isSignedIn() && (
        targetNotExists() || // allow reading non-existent docs
        // standalone: visible to creator (check createdBy first)
        ('createdBy' in resource.data && resource.data.createdBy == request.auth.uid && 
         (!('courseId' in resource.data) || resource.data.courseId == null)) ||
        // course-bound assignments: visible to course members
        ('courseId' in resource.data && resource.data.courseId != null && isCourseMember(resource.data.courseId))
      );

      allow list: if isSignedIn() && (
        targetNotExists() || // allow listing empty collection
        // standalone: visible to creator (check createdBy first)
        ('createdBy' in resource.data && resource.data.createdBy == request.auth.uid && 
         (!('courseId' in resource.data) || resource.data.courseId == null)) ||
        // course-bound assignments: visible to course members
        ('courseId' in resource.data && resource.data.courseId != null && isCourseMember(resource.data.courseId))
      );

      // Create/update by course instructors/TAs or assignment creator for standalone
      allow create: if isSignedIn() && (
        (request.resource.data.courseId != null &&
           (canEditCourseResource(request.resource.data.courseId))) ||
        (request.resource.data.courseId == null && request.resource.data.createdBy == request.auth.uid)
      ) && isValidAssignment(request.resource.data);

      allow update: if isSignedIn() && (
        (resource.data.courseId != null &&
           (canEditCourseResource(resource.data.courseId))) ||
        (resource.data.courseId == null && resource.data.createdBy == request.auth.uid)
      ) && isValidAssignment(request.resource.data);

      allow delete: if isSignedIn() && (
        (resource.data.courseId != null &&
           (canEditCourseResource(resource.data.courseId))) ||
        (resource.data.courseId == null && resource.data.createdBy == request.auth.uid)
      );

      /* ------ Submissions subcollection ------ */
      match /submissions/{userId} {
        // GET:
        // - The student may read their own submission
        // - Instructors/TAs of the course may read all
        allow get: if isSignedIn() && (
          userId == request.auth.uid ||
          (get(/databases/$(database)/documents/assignments/$(aid)).data.courseId != null &&
           canEditCourseResource(get(/databases/$(database)/documents/assignments/$(aid)).data.courseId))
        );

        // LIST:
        // - Instructors/TAs can list all submissions
        // - Students cannot list (can only get their own)
        allow list: if isSignedIn() && (
          get(/databases/$(database)/documents/assignments/$(aid)).data.courseId != null &&
          canEditCourseResource(get(/databases/$(database)/documents/assignments/$(aid)).data.courseId)
        );

        // CREATE by the student (their own doc id == uid)
        allow create: if isSignedIn() && 
          userId == request.auth.uid &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.state == "in_progress" &&
          isValidSubmission(request.resource.data);
        
        // UPDATE by the student or instructor/TA
        allow update: if isSignedIn() && isValidSubmission(request.resource.data) && (
          // Student can edit their own while in progress or submit
          (userId == request.auth.uid &&
           request.resource.data.userId == request.auth.uid &&
           (
             (resource.data.state == "in_progress" && 
              request.resource.data.state in ["in_progress", "submitted"]) ||
             (resource.data.state == "submitted" && 
              request.resource.data.state == "submitted")
           )) ||

          // Instructor/TA can grade (move to graded_complete, set notes/score)
          (get(/databases/$(database)/documents/assignments/$(aid)).data.courseId != null &&
           canEditCourseResource(get(/databases/$(database)/documents/assignments/$(aid)).data.courseId))
        );

        // Prevent deletion by students; allow for instructors if you really need it
        allow delete: if isSignedIn() && (
          get(/databases/$(database)/documents/assignments/$(aid)).data.courseId != null &&
          isInstructorOfCourse(get(/databases/$(database)/documents/assignments/$(aid)).data.courseId)
        );
      }
    }

    /* ---------- Conversations (top-level) ---------- */
    match /conversations/{cid} {
      // GET:
      // - Owner (student)
      // - Instructors/TAs of linked assignment course
      allow get: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        (
          // Safely read assignment to resolve course
          exists(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)) &&
          canEditCourseResource(get(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)).data.courseId)
        )
      );

      // LIST:
      // - Owner (student) can list their own conversations
      // - Instructors/TAs of linked assignment course can list
      allow list: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        (
          // Safely read assignment to resolve course
          exists(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)) &&
          canEditCourseResource(get(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)).data.courseId)
        )
      );

      // CREATE: student creates their own conversation only
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        isValidConversation(request.resource.data);

      // UPDATE:
      // - Student can append turns / move through allowed states
      // - Instructors/TAs can move to closed
      // - If the last turn's pendingStartAt is not null, updates are denied
      allow update: if isSignedIn() &&
        isValidConversation(request.resource.data) &&
        (
          // Disallow update if last turn's pendingStartAt is not null
          (resource.data.turns.size() == 0 || resource.data.turns[resource.data.turns.size() - 1].pendingStartAt == null)
        ) && (
          request.auth.uid == resource.data.userId ||
          (
            exists(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)) &&
            canEditCourseResource(get(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)).data.courseId)
          )
        );

      // DELETE: typically disallow
      allow delete: if false;
    }

    /* ---------- Collection Group Rules ---------- */
    
    // Roster collection group - allows users to query their own roster entries across all courses
    match /{path=**}/roster/{memberId} {
      // Users can only query their own roster entries across all courses
      // This supports listMyEnrolledCourses API which queries: 
      // collectionGroup("roster").where("userId", "==", currentUser.uid).where("status", "==", "active")
      allow read: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }

    /* ---------- Fallback ---------- */
    match /{document=**} {
      // Fallback deny
      allow get, list: if false;
      allow create, update, delete: if false;
    }
  }
}
