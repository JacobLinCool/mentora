// MOCK API - Text to Speech
import { requireAuth } from "$lib/server/auth";
import { json, error as svelteError } from "@sveltejs/kit";
import type { RequestHandler } from "./$types";

/**
 * POST /api/voice/synthesize
 * Convert text to audio (Text-to-Speech)
 *
 * Request: { text: string, voiceId?: string }
 * Response: { audioContent: base64, contentType: string }
 */
export const POST: RequestHandler = async (event) => {
    await requireAuth(event);

    const body = await event.request.json();
    const { text } = body;

    if (!text || typeof text !== "string" || text.trim().length === 0) {
        throw svelteError(400, "Missing or empty text");
    }

    if (text.length > 5000) {
        throw svelteError(400, "Text too long (max 5000 characters)");
    }

    // TODO: Integrate with text-to-speech service (e.g., Google TTS, ElevenLabs)
    // voiceId can be used to select different voices

    // Return minimal valid MP3 (silence) for testing
    const silentMp3 = new Uint8Array([
        0xff, 0xfb, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x58, 0x69, 0x6e, 0x67, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x24, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 0xfb, 0x90, 0x00,
    ]);

    // Convert to Base64
    const audioContent = Buffer.from(silentMp3).toString("base64");

    return json({
        audioContent,
        contentType: "audio/mpeg",
    });
};
